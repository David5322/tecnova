@using TostonApp.Security
@inject IPermisosService Permisos

<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - TostonApp</title>

    <!-- Tailwind CDN (SIN COMPILAR) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#16a34a',     // green-600
                        primarySoft: '#dcfce7' // green-100
                    }
                }
            }
        }
    </script>
</head>

<body class="h-full bg-white text-slate-800">
    <div class="min-h-full">

        <!-- TOPBAR -->
        <header class="sticky top-0 z-40 border-b border-green-100 bg-white/90 backdrop-blur">
            <div class="mx-auto flex max-w-7xl items-center justify-between px-4 py-3">
                <div class="flex items-center gap-3">
                    <button id="openSidebar"
                            class="rounded-xl border border-green-100 bg-white p-2 text-green-700 shadow-sm lg:hidden">
                        ☰
                    </button>

                    <a asp-controller="Home" asp-action="Index"
                       class="flex items-center gap-2 font-semibold text-slate-900">
                        <span class="flex h-10 w-10 items-center justify-center rounded-xl bg-primary text-white">
                            🍃
                        </span>
                        TostonApp
                    </a>
                </div>

                <!-- USER -->
                <div class="relative">
                    <button id="userBtn"
                            class="flex items-center gap-2 rounded-xl border border-green-100 px-3 py-2 text-sm hover:bg-green-50">
                        👤
                        <span>@(User.Identity?.IsAuthenticated == true ? User.Identity.Name : "Invitado")</span>
                    </button>

                    <div id="userMenu"
                         class="absolute right-0 mt-2 hidden w-48 rounded-xl border border-green-100 bg-white shadow-lg">
                        @if (User.Identity?.IsAuthenticated == true)
                        {
                            <a href="/Identity/Account/Manage" class="block px-4 py-2 hover:bg-green-50">Mi cuenta</a>
                            <form method="post" action="/Identity/Account/Logout">
                                @Html.AntiForgeryToken()
                                <button class="w-full px-4 py-2 text-left hover:bg-green-50">Cerrar sesión</button>
                            </form>
                        }
                        else
                        {
                            <a href="/Identity/Account/Login" class="block px-4 py-2 hover:bg-green-50">Login</a>
                            <a href="/Identity/Account/Register" class="block px-4 py-2 hover:bg-green-50">Registro</a>
                        }
                    </div>
                </div>
            </div>
        </header>

        <!-- BODY -->
        <div class="mx-auto flex max-w-7xl gap-6 px-4 py-6">

            <!-- SIDEBAR -->
            <aside id="sidebar"
                   class="hidden w-64 rounded-2xl border border-green-100 bg-white p-4 shadow-sm lg:block">
                <nav class="space-y-1">

                    <a asp-controller="Home" asp-action="Index" class="menu-item">🏠 Inicio</a>

                    @if (await Permisos.CanAsync(User, "PRODUCTOS_VER"))
                    {
                        <a asp-controller="Productos" asp-action="Index" class="menu-item">📦 Productos</a>
                    }

                    @if (await Permisos.CanAsync(User, "CONFIG_VER"))
                    {
                        <a asp-controller="Configuracion" asp-action="Index" class="menu-item">⚙️ Configuración</a>
                    }

                    @if (await Permisos.CanAsync(User, "USUARIOS_VER"))
                    {
                        <a asp-controller="Configuracion" asp-action="Usuarios" class="menu-item">👥 Usuarios</a>
                    }
                </nav>
            </aside>

            <!-- MAIN -->
            <main class="flex-1">
                @if (TempData["Ok"] != null)
                {
                    <div class="mb-4 rounded-xl bg-green-100 px-4 py-2 text-green-800">
                        @TempData["Ok"]
                    </div>
                }

                @if (TempData["Error"] != null)
                {
                    <div class="mb-4 rounded-xl bg-red-100 px-4 py-2 text-red-800">
                        @TempData["Error"]
                    </div>
                }

                <div class="rounded-2xl border border-green-100 bg-white p-5 shadow-sm">
                    @RenderBody()
                </div>
            </main>
        </div>
    </div>

    <style>
        .menu-item {
            display: block;
            padding: .6rem .75rem;
            border-radius: .75rem;
            color: #334155;
        }

            .menu-item:hover {
                background: #dcfce7;
                color: #166534;
            }
    </style>

    <script>
        // User menu
        document.getElementById("userBtn")?.addEventListener("click", () => {
            document.getElementById("userMenu")?.classList.toggle("hidden");
        });

        // Sidebar mobile
        document.getElementById("openSidebar")?.addEventListener("click", () => {
            document.getElementById("sidebar")?.classList.toggle("hidden");
        });
    </script>

    @RenderSection("Scripts", required: false)
</body>
</html>
